<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>The Trade Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  background:#0b0f18;
  color:white;
  font-family:Segoe UI;
  margin:0;
}

.header{
  text-align:center;
  padding:16px;
  font-size:26px;
  font-weight:900;
  background:#111a33;
}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr); /* Desktop: 4 cards */
  gap:16px;
  padding:16px;
}

/* Tablet view */
@media (max-width: 1024px){
  .grid{
    grid-template-columns:repeat(3,1fr);
  }
}

/* Mobile view */
@media (max-width: 600px){
  .grid{
    grid-template-columns:repeat(2,1fr); /* Mobile: 2 cards */
  }
}


.card{
  border-radius:14px;
  padding:12px;
  height:230px;
  cursor:pointer;
  transition:0.2s;
}

/* COLORS */
.card.grey{
  background:linear-gradient(145deg,#555,#333);
}
.card.blue{
  background:linear-gradient(145deg,#1e2d5f,#0c1433);
}
.card.red{
  background:linear-gradient(145deg,#5b1111,#2a0505);
}

/* TEXT */
.instrument{
  font-size:18px;
  font-weight:800;
  text-align:center;
}
.row{
  text-align:center;
  font-size:12px;
  margin-top:4px;
}
.body{
  text-align:center;
  font-size:44px;
  font-weight:900;
  margin-top:10px;
  letter-spacing:3px;
}
.subtext{
  text-align:center;
  font-size:14px;
  margin-top:6px;
  font-weight:700;
}

/* SIGNAL COLORS */
.buy{color:#00ff9c;}
.sell{color:#ff5c5c;}
.warn{
  color:#ffd000;
  background:black;
  padding:4px 10px;
  border-radius:6px;
  font-weight:900;
  font-size:24px;
  display:inline-block;
}

/* MODAL */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal{
  background:#111a33;
  padding:16px;
  border-radius:12px;
  width:420px;
}

.section{margin-top:10px;}
.section b{font-size:12px;}

.pill{
  display:inline-block;
  padding:6px 10px;
  margin:4px;
  border:1px solid #777;
  border-radius:10px;
  font-size:12px;
  cursor:pointer;
}
.pill.active{
  background:white;
  color:black;
  font-weight:800;
}

.separator{
  border-top:1px solid #444;
  margin:10px 0;
}

button{
  width:100%;
  margin-top:10px;
  padding:8px;
}
</style>
</head>

<body>

<div class="header">THE TRADE INTELLIGENCE</div>
<div class="grid" id="board"></div>

<div class="overlay" id="overlay">
<div class="modal">
<h2 id="title"></h2>

<div class="section">
<b>Trend</b><br>
<span class="pill" onclick="toggle('trend','Bullish')">Bullish</span>
<span class="pill" onclick="toggle('trend','Bearish')">Bearish</span>
</div>

<div class="separator"></div>

<div class="section">
<span class="pill" onclick="toggle('clean',true)">Clean</span>
</div>

<div class="separator"></div>

<div class="section">
<b>Parallel Channel Proper</b><br>
<span class="pill" onclick="toggle('pc','Bullish')">Bullish Parallel Channel Proper</span>
<span class="pill" onclick="toggle('pc','Bearish')">Bearish Parallel Channel Proper</span>
</div>

<div class="section">
<b>Double Top / Bottom</b><br>
<span class="pill" onclick="toggle('dt','Proper')">Proper</span>
<span class="pill" onclick="toggle('dt','Deep')">Deep Pullback</span>
</div>

<div class="section">
<b>Consolidation</b><br>
<span class="pill" onclick="toggle('con','<1.5RR')">&lt;1.5RR</span>
<span class="pill" onclick="toggle('con','2RR')">2RR</span>
<span class="pill" onclick="toggle('con','Neckline')">At Neckline</span>
</div>

<div class="section">
<b>Inside Candle</b><br>
<span class="pill" onclick="toggle('inside','Clean Neckline')">Clean Neckline</span>
<span class="pill" onclick="toggle('inside','Submerged')">Submerged</span>
</div>

<div class="section">
<b>Traps</b><br>
<span class="pill" onclick="toggle('liq',true)">Liquidity Trap</span>
<span class="pill" onclick="toggle('pct',true)">PCT</span>
</div>

<div class="section">
<b>SMMA</b><br>
<span class="pill" onclick="toggle('smma',true)">Accumulation at SMMA</span>
</div>

<button onclick="closeModal()">Close</button>
</div>
</div>

<script>
const instruments=[
"EURUSD","GBPUSD","EURGBP","USDJPY",
"GBPJPY","AUDUSD","USDCAD","NZDUSD",
"SP500","UK100","NAS100","XAUUSD","BTCUSD"
];

const board=document.getElementById("board");
const overlay=document.getElementById("overlay");
const title=document.getElementById("title");

let active=null;
let state={};

instruments.forEach(i=>{
  state[i]={
    trend:null,
    clean:false,
    pc:null,
    dt:null,
    con:null,
    inside:null,
    liq:false,
    pct:false,
    smma:false
  };

  const c=document.createElement("div");
  c.className="card grey";
  c.id=i;
  c.innerHTML=`
    <div class="instrument">${i}</div>
    <div class="row" id="${i}_trend">Trend: —</div>
    <div class="row" id="${i}_cat">Category: —</div>
    <div class="body">—</div>
    <div class="subtext"></div>
  `;
  c.onclick=()=>openModal(i);
  board.appendChild(c);
});

function openModal(n){
  active=n;
  title.innerText=n;
  overlay.style.display="flex";
  refreshModal();
}
function closeModal(){ overlay.style.display="none"; }

function toggle(key,val){
  if(typeof state[active][key]==="boolean"){
    state[active][key]=!state[active][key];
  }else{
    state[active][key]=state[active][key]===val?null:val;
  }
  update(active);
  refreshModal();
}

function refreshModal(){
  document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
  const s=state[active];

  document.querySelectorAll(".pill").forEach(p=>{
    const t=p.innerText;

    if(t==="Bullish" && s.trend==="Bullish")p.classList.add("active");
    if(t==="Bearish" && s.trend==="Bearish")p.classList.add("active");
    if(t==="Clean" && s.clean)p.classList.add("active");

    if(t.includes("Bullish Parallel") && s.pc==="Bullish")p.classList.add("active");
    if(t.includes("Bearish Parallel") && s.pc==="Bearish")p.classList.add("active");

    if(t==="Proper" && s.dt==="Proper")p.classList.add("active");
    if(t==="Deep Pullback" && s.dt==="Deep")p.classList.add("active");

    if(t==="<1.5RR" && s.con==="<1.5RR")p.classList.add("active");
    if(t==="2RR" && s.con==="2RR")p.classList.add("active");
    if(t==="At Neckline" && s.con==="Neckline")p.classList.add("active");

    if(t==="Clean Neckline" && s.inside==="Clean Neckline")p.classList.add("active");
    if(t==="Submerged" && s.inside==="Submerged")p.classList.add("active");

    if(t==="Liquidity Trap" && s.liq)p.classList.add("active");
    if(t==="PCT" && s.pct)p.classList.add("active");
    if(t==="Accumulation at SMMA" && s.smma)p.classList.add("active");
  });
}

function update(n){
  const s=state[n];
  const card=document.getElementById(n);

  /* default */
  card.className="card grey";

// If trend is selected, make card BLUE by default
if(s.trend){
  card.className = "card blue";
}


  document.getElementById(n+"_trend").innerText="Trend: "+(s.trend||"—");

  let cats=[];
  if(s.clean) cats.push("Clean");
  if(s.pc) cats.push(s.pc+" Parallel Channel Proper");
  if(s.dt) cats.push("Double Top/Bottom");
  if(s.con) cats.push("Consolidation");
  if(s.inside) cats.push(s.inside);
  if(s.liq) cats.push("Liquidity Trap");
  if(s.pct) cats.push("PCT");
  if(s.smma) cats.push("Accumulation at SMMA");

  document.getElementById(n+"_cat").innerText="Category: "+(cats.length?cats.join(" & "):"—");

  let action="—";
  let sub="";

  /* NO TRADE */
  if(
    s.pct ||
    s.smma ||
    s.inside==="Submerged" ||
    s.con==="<1.5RR" ||
    s.dt==="Proper"
  ){
    action="⛔ NO TRADE";
    card.className="card red";
  }

  /* DEEP PULLBACK */
  else if(s.dt==="Deep" && s.trend){
    action = s.trend==="Bullish"
      ? `<span class="buy">⬆ BUY</span>`
      : `<span class="sell">⬇ SELL</span>`;
    sub="Deep pullback – trade with trend";
    card.className="card blue";
  }

  /* CLEAN MODE */
  else if(s.clean && s.trend){
    action = s.trend==="Bullish"
      ? `<span class="buy">⬆ BUY</span>`
      : `<span class="sell">⬇ SELL</span>`;
    card.className="card blue";
  }

  /* CAUTION ONLY */
  else if(s.con==="2RR" || s.con==="Neckline" || s.liq){
    action=`<span class="warn">⚠</span>`;
    if(s.con==="2RR") sub="Only trade with 1.5 RR";
    if(s.con==="Neckline") sub="Only trade after failed breakout";
    if(s.liq) sub="Trade only after candle closes beyond wick";
    if(s.trend) card.className="card blue";
  }

  /* PARALLEL CHANNEL PROPER */
  else if(s.trend && s.pc){
    if(s.trend==="Bullish" && s.pc==="Bullish"){
      action=`<span class="warn">⚠</span><br><span class="buy">⬆ BUY</span>`;
      sub="Buy only near lower line";
    }
    if(s.trend==="Bearish" && s.pc==="Bearish"){
      action=`<span class="warn">⚠</span><br><span class="sell">⬇ SELL</span>`;
      sub="Sell only near upper line";
    }
    if(s.trend==="Bullish" && s.pc==="Bearish"){
      action=`<span class="buy">⬆ BUY</span>`;
      sub="Be cautious near new points";
    }
    if(s.trend==="Bearish" && s.pc==="Bullish"){
      action=`<span class="sell">⬇ SELL</span>`;
      sub="Be cautious near new points";
    }
    card.className="card blue";
  }

  document.querySelector("#"+n+" .body").innerHTML=action;
  document.querySelector("#"+n+" .subtext").innerText=sub;
}
</script>

<!-- REVIEW + NOTIFICATION SYSTEM (APPEND ONLY) -->
<style>
.card.yellow{
  background:linear-gradient(145deg,#c2a500,#6b5a00);
}
</style>

<script>
/* ===========================
   REVIEW CONFIG
=========================== */

const REVIEW_TIMERS = {
  trend: 48 * 60 * 60 * 1000,           // 48 hours
  pc: 100 * 60 * 60 * 1000,             // 100 hours
  liq: 2 * 60 * 60 * 1000,              // 2 hours
  inside: 5 * 60 * 60 * 1000,           // 5 hours
  dt: 5 * 60 * 60 * 1000,               // 5 hours
  con: 5 * 60 * 60 * 1000,              // 5 hours
  smma: 5 * 60 * 60 * 1000              // 5 hours
};

// Store timestamps + notification flags
let reviewState = {};

// Initialize review storage
for (let inst in state) {
  reviewState[inst] = {
    timestamps: {},
    notified: false
  };
}

/* ===========================
   SOUND
=========================== */
const reviewSound = new Audio(
  "https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
);

/* ===========================
   NOTIFICATION PERMISSION
=========================== */
if ("Notification" in window) {
  if (Notification.permission !== "granted") {
    Notification.requestPermission();
  }
}

/* ===========================
   HOOK INTO YOUR toggle()
=========================== */

// Save original toggle
const originalToggle = toggle;

toggle = function(key, val) {
  // Call your existing logic
  originalToggle(key, val);

  // Save timestamp if this category has a review timer
  if (REVIEW_TIMERS[key]) {
    reviewState[active].timestamps[key] = Date.now();
    reviewState[active].notified = false;
  }
};

/* ===========================
   REVIEW CHECKER
=========================== */

function checkReviews() {
  const now = Date.now();

  for (let inst in state) {
    const card = document.getElementById(inst);
    const body = card.querySelector(".body");
    const sub = card.querySelector(".subtext");

    let needsReview = false;

    const timestamps = reviewState[inst].timestamps;

    for (let key in timestamps) {
      if (REVIEW_TIMERS[key]) {
        if (now - timestamps[key] > REVIEW_TIMERS[key]) {
          needsReview = true;
          break;
        }
      }
    }

    if (needsReview) {
      // Turn card yellow unless already red
      if (!card.classList.contains("red")) {
        card.className = "card yellow";
      }

      // Override signal
      body.innerHTML = `<span class="warn">⚠ REVIEW</span>`;
      sub.innerText = "Time expired – needs revalidation";

      // Fire notification once
      if (!reviewState[inst].notified) {
        reviewState[inst].notified = true;

        // Sound
        reviewSound.play();

        // Desktop notification
        if (Notification.permission === "granted") {
          new Notification(`${inst} – Review Needed`, {
            body: "Time expired. Recheck structure.",
            icon: "https://cdn-icons-png.flaticon.com/512/1828/1828843.png"
          });
        }
      }
    }
  }
}

// Check every 30 seconds
setInterval(checkReviews, 30000);

// Run immediately on load
checkReviews();
</script>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>

<script>
/* ===========================
   REVIEW COLOR OVERRIDE LAYER
   (HIGHEST PRIORITY)
=========================== */

function applyReviewOverride(inst){
  const card = document.getElementById(inst);
  const body = card.querySelector(".body");
  const sub = card.querySelector(".subtext");

  // Force yellow
  card.className = "card yellow";

  // Force review text
  body.innerHTML = `<span class="warn">⚠ REVIEW</span>`;
  sub.innerText = "Time expired – needs revalidation";
}

function enhancedCheckReviews(){
  const now = Date.now();

  for(let inst in reviewState){
    const timestamps = reviewState[inst].timestamps;
    let expired = false;

    for(let key in timestamps){
      if(REVIEW_TIMERS[key]){
        if(now - timestamps[key] > REVIEW_TIMERS[key]){
          expired = true;
          break;
        }
      }
    }

    if(expired){
      applyReviewOverride(inst);

      // notification only once
      if(!reviewState[inst].notified){
        reviewState[inst].notified = true;

        // sound
        reviewSound.play();

        // browser notification
        if(Notification.permission === "granted"){
          new Notification(`${inst} – Review Needed`, {
            body: "Time expired. Recheck structure."
          });
        }
      }
    }
  }
}

// Replace old checker
clearInterval(window.reviewInterval);
window.reviewInterval = setInterval(enhancedCheckReviews, 15000);

// Run once immediately
enhancedCheckReviews();
</script>


/* ===========================
   FIREBASE SETUP
=========================== */

const firebaseConfig = {

  apiKey: "AIzaSyAR1wt_7qeaAMXcpJ8EGj1PolZRWFxpN9o",

  authDomain: "trade-intelligence-3bbe8.firebaseapp.com",

  projectId: "trade-intelligence-3bbe8",

  storageBucket: "trade-intelligence-3bbe8.firebasestorage.app",

  messagingSenderId: "36886806770",

  appId: "1:36886806770:web:b438cb5402a6407599506b",

  measurementId: "G-Q62FWPFFXG"

};


firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===========================
   CLOUD STATE SYNC
=========================== */

const CLOUD_DOC = db.collection("tradeState").doc("global");

/* Save to cloud */
function saveToCloud() {
  CLOUD_DOC.set({
    state: state,
    reviewState: reviewState,
    updated: Date.now()
  });
}

/* Load from cloud */
function loadFromCloud() {
  CLOUD_DOC.get().then(doc => {
    if (doc.exists) {
      const data = doc.data();
      state = data.state;
      reviewState = data.reviewState;
      for (let inst in state) {
        update(inst);
      }
    }
  });
}

/* Real-time sync */
CLOUD_DOC.onSnapshot(doc => {
  if (doc.exists) {
    const data = doc.data();
    state = data.state;
    reviewState = data.reviewState;
    for (let inst in state) {
      update(inst);
    }
  }
});

/* Hook into toggle */
const oldToggleCloud = toggle;
toggle = function(key, val){
  oldToggleCloud(key, val);
  saveToCloud();
};

/* Load cloud state on start */
window.addEventListener("load", () => {
  loadFromCloud();
});
</script>


</body>
</html>
